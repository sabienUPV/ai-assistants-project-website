---
import Layout from "@layouts/Layout.astro";
import { homeNoLocale } from "@utils/url";
import { tForLocale } from "@utils/translation";
import { locales, defaultLocale } from "@languages";
import { getRelativeLocaleUrl } from "astro:i18n";

// Pre-calculate translations and routes for all available locales during the build step.
// This creates a dictionary that avoids fetching data on the client side, keeping the page static.
const dataForAllLocales = locales.reduce((acc, locale) => {
  acc[locale] = {
    title: tForLocale(locale, "404_title"),
    description: tForLocale(locale, "404_description"),
    backHome: tForLocale(locale, "404_back_home"),
    homeLink: getRelativeLocaleUrl(locale),
  };
  return acc;
}, {} as Record<string, { title: string; description: string; backHome: string; homeLink: string }>);
---

<Layout title={`404: ${tForLocale(defaultLocale, "404_title")}`}>
  <div id="error-container" class="error-container" data-locales={JSON.stringify(dataForAllLocales)}>
    <div class="error-content">
      <h1>404</h1>
      <h2 id="404-title">{tForLocale(defaultLocale, "404_title")}</h2>
      <p id="404-description">{tForLocale(defaultLocale, "404_description")}</p>
      
      <a id="404-back-home" href={homeNoLocale()} class="back-button">
        {tForLocale(defaultLocale, "404_back_home")}
      </a>
    </div>
  </div>
</Layout>

<script>
  // Import the shared utility function to strictly enforce DRY (Don't Repeat Yourself) principles
  import { extractLocaleFromPath } from "@utils/localizedUrl";

  // 1. Retrieve the container element that holds our serialized locale data
  const container = document.getElementById("error-container");
  
  if (container && container.dataset.locales) {
    // 2. Parse the pre-calculated dictionary from the data attribute
    const dataForAllLocales = JSON.parse(container.dataset.locales);
    
    // 3. Determine the user's intended locale based on the current URL path
    const currentPath = window.location.pathname;
    const detectedLocale = extractLocaleFromPath(currentPath);

    // 4. If a valid locale is found, dynamically update the DOM elements to match that language
    if (detectedLocale && dataForAllLocales[detectedLocale]) {
      const { title, description, backHome, homeLink } = dataForAllLocales[detectedLocale];
      
      const titleElement = document.getElementById("404-title");
      const descriptionElement = document.getElementById("404-description");
      const backHomeElement = document.getElementById("404-back-home") as HTMLAnchorElement | null;

      // Update text content and hrefs immediately to provide a localized error experience
      if (titleElement && descriptionElement && backHomeElement) {
        const separator = " - ";
        document.title += separator + title;
        titleElement.textContent += separator + title;
        descriptionElement.textContent += separator + description;
        backHomeElement.href = homeLink;
        backHomeElement.textContent += separator + backHome;
      }
    }
  }
</script>

{/*
Hide the Locale Selector in the 404 page
to hide the fact that it doesn't detect the language from the path like we do here
(it's okay since it doesn't make a lot of sense to switch languages from a 404 page in the first place,
just go back to the homepage or any other page and switch from there if needed)
*/}
<style is:global>
  .locale-selector {
    display: none;
  }
</style>

<style>
  .error-container {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 60vh;
    padding: 2rem 1rem;
    text-align: center;
    color: var(--color-text);
  }

  .error-content { max-width: 500px; }
  h1 { font-size: 6rem; margin: 0; line-height: 1; color: var(--color-secondary); }
  h2 { font-size: 2rem; margin: 0.5rem 0 1.5rem; }
  p { margin-bottom: 2rem; font-size: 1.1rem; }
  
  .back-button {
    display: inline-block;
    background-color: var(--color-secondary);
    color: white;
    padding: 0.75rem 1.5rem;
    border-radius: 2rem;
    text-decoration: none;
    font-weight: 600;
    transition: transform 0.2s ease, opacity 0.2s ease;
  }

  .back-button:hover {
    transform: scale(1.05);
    opacity: 0.9;
  }
</style>